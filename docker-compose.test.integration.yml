# docker-compose.test.integration.yml (updated)
services: 
  test_runner:
    container_name: test_runner_integration
    build:
      context: ./tests/integration
      dockerfile: Dockerfile
    # --- MODIFIED SECTION ---
    # Now, this service will not even start until the 'backend'
    # service reports that it is healthy.
    depends_on:
      backend:
        condition: service_healthy
    command: ["poetry", "run", "pytest", "-v"]
  
  backend:
    container_name: backend_integration_test
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - DATABASE_URL=mongodb://mongodb_test:27017
      - STT_URL=http://stt:9000
      - TRANSLATION_URL=http://translation:9001
      - SUMMARIZATION_URL=http://summarization:9002
    depends_on:
      - mongodb_test
    # --- NEW SECTION ---
    # This tells Docker how to determine if the backend is ready.
    healthcheck:
      # The command runs INSIDE the container. 'curl -f' fails with a non-zero
      # exit code if the HTTP status is an error (like 4xx or 5xx).
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 5s       # Check every 5 seconds
      timeout: 10s       # Wait up to 10 seconds for a response
      retries: 5         # Try up to 5 times before marking as unhealthy
      start_period: 20s  # Grace period for startup to avoid premature failures

  mongodb_test:
    container_name: mongodb_integration_test
    image: mongo:latest
    command: mongod --quiet --logpath /dev/null
    # You can also add a healthcheck to mongo!
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 20s
